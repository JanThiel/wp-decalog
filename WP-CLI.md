DecaLog is fully usable from command-line, thanks to [WP-CLI](https://wp-cli.org/). You can set DecaLog options, view past or current triggered events and much more, without using a web browser.

1. [Introduction](#introduction)
2. [Viewing events](#viewing-events) - `wp log tail`
3. [Triggering events](#triggering-events) - `wp log send`
4. [Managing loggers](#managing-loggers) - `wp log logger`
5. [Using logger types](#managing-loggers) - `wp log type`
6. [Managing listeners](#managing-loggers) - `wp log listener`
7. [Getting DecaLog status](#getting-decalog-status) - `wp log status`
8. [Managing main settings](#managing-main-settings) - `wp log settings`

## Introduction
DecaLog is WordPress plugin which that to:
- capture events generated by the core of WordPress, themes and plugins;
- enrich these events with many details regarding their triggering;
- record these events in the WordPress database and/or send them to external services for logging, monitoring and alerting;
- view (and filter) events recorded in the WordPress database.

### Definitions
When using DecaLog, you will have to deal with the following notions:
- __Event__ - An event is some bits of information regarding something which happened while executing WordPress. See [Anatomy of an event](#anatomy-of-an-event) to know what it's made of.
- __Listener__ - A listener is, as its name suggests, something that listens to what's going on in a specific _perimeter_ (mainly a specific WordPress component or subsystem), make it an ___event___ and pass this ___event___ to the running ___loggers___.
- __Logger__ - A logger is a _recorder_ of ___events___. It can filter them (accept or refuse to record the ___event___ based on settings) then store them (in a database, a file, etc.), send them (via API calls, sockets, mails, etc.) or display them in WP-CLI console.

### Anatomy of an event
An ___event___ is composed of:
- A __channel__, which is the type of "execution pipe" that triggered the ___event___. It can take the following values: `CLI` (command-line interface), `CRON` (cron job), `AJAX` (Ajax request), `XMLRPC` (XML-RPC request), `API` (Rest API request), `FEED` (Atom/RDF/RSS feed), `WBACK` (site backend), `WFRONT` (site frontend).
- A __level__, which represents the severity of the ___event___. This level is set by the ___listener___, regarding what triggered the ___event___. It can take the following values (from the lowest severity to the highest severity): `DEBUG`, `INFO`, `NOTICE`, `WARNING`, `ERROR`, `CRITICAL`, `ALERT`, `EMERGENCY`.
- A __timestamp__, which is the time when ___event___ was triggered.
- A versioned __source__, which is the component or the subsystem where the ___event___ is triggered. It may be things like `PHP`/`7.2` or `WordPress`/`5.2.2` and so on...
- The __class__ of the source, which can take the following values: `core`, `plugin`, `theme`, `db`, `php`.
- A __message__ in plain text. It is always in English: messages are not localized.
- A numerical __code__, which may be everything which makes sense regarding the ___event___ (an error code, for instance).

Depending on each ___loggers___ settings, an ___event___ may contains many other fields which are automatically detected and filled by DecaLog.

### Levels standards
In order to be similar to other log management systems and to maintain consistency between all the DecaLog ___listeners___, the ___levels___ are used as follows:
* `DEBUG` - Only used for events related to application/system debugging. Must not concern standard, important or critical events. _Ex.: "Plugin table xxx updated.", "Textdomain yyy loaded."_.
* `INFO` - Simple informational messages which can be forgotten. _Ex.: "User xxx is logged-out.", "New comment on post yyy."_.
* `NOTICE` - Normal but significant conditions. _Ex.: "The configuration of plugin xxx was modified.", "The database is 70% full."_.
* `WARNING` - A significant condition indicating a situation that may lead to an error if recurring or if no action is taken. _Ex.: "Page not found.", "Comment flood triggered."_.
* `ERROR` - Minor operating error which requires investigation and preventive treatment. _Ex.: "The file could not be opened.", "The feature could not be loaded."_.
* `CRITICAL` - Operating error which requires investigation and corrective treatment. _Ex.: "Uncaught Exception!", "Database error in query xxx."_.
* `ALERT` - Major operating error which requires immediate corrective treatment. _Ex.: "The WordPress database is corrupted."_.
* `EMERGENCY` - A panic condition (unusable system). _Ex.: "The WordPress database is down.", "Parse error: syntax error, unexpected 'if' (T_IF)."_.

## Viewing events

DecaLog lets you use command-line to view past and currents events. All is done via the `wp log tail <count>` command.

If you don't specify `<count>`, DecaLog will launch an interactive logging session: it will display events as soon as they occur on your site. To quit this session, hit `CTRL+C``

If you specifiy a value for `<count>` between 1 to 60, DecaLog will show you the *count* last events triggered on your site.

> Note the `tail` command needs shared memory support on your server, both for web server and command-line configuration. If it's not already the case, you must activate the ***shmop*** PHP module.

Whether it's an interactive session or viewing past events, you can filter what is displayed as follows:

### Minimal level

To display only events having a minimal level, use `--level=<level>` parameter. `<level>` can be `info`, `notice`, `warning`, `error`, `critical`, `alert` or `emergency`.

> Note you can not use `debug` as minimal level because the internal logger which capture events for the tail command rejects them for this level.

### Field filters

You can filter displayed events on fields too. To do it, use the `--filter=<filter>` parameter. `<filter>` is a json string containing "field":"regexp" pairs. The available fields are: 'channel', 'message', 'class', 'source', 'code', 'site_id' (on multisite only), 'user_id', 'remote_ip', 'url', 'verb', 'server', 'referrer', 'file', 'line', 'classname' and 'function'.

Each regular expression must be surrounded by `/` like that: `"remote_ip":"/(135\.|164\.)/"` and the whole filter must start with `'{` and end with `}'` (see examples).

### Outputted format

You can tailor the outputted format to fit your needs with the `--format=<format>` parameter. There's 3 available formats:
- `wp`: that's the default format; it shows (after the standard details) the source component and the message.
- `http`: it shows (after the standard details) the verb (get, post, etc.), IP source and relative url.
- `php`: it shows (after the standard details) in which portion of code the event was triggered.

### Columns count

By default, DecaLog will output each event string on a 160 character basis. If you want to change it, use `--col=<columns>` where `<columns>` is an integer between 80 and 400.

### Colors scheme

To change the default color scheme to something more *eyes-saving*, use `--soft`.

### Examples

To see all "live" events, type the following command:
```bash
wp log tail
```

To see past alerts for user 1, type the following command:
```bash
wp log tail 20 --filter='{"user_id":"/1+/"}' --level=alert
```

To see "live" events only triggered by WordPress core on cron calls, type the following command:
```bash
wp log tail --filter='{"channel":"/cron/", "class":"/core/"}'
```

To see "live" error that occur with specific http verbs, type the following command:
```bash
wp log tail --filter='{"verb":"/(options|connect|trace)/", "class":"/api/"}' --level=error --format=http
```

## Triggering events

You can trigger events right from your scripts with the `wp log send <info|notice|warning|error|critical|alert> <message>` command where `<message>` is a string surrounded by quotes.

> This method is reserved to scripts; if you're a theme or plugin developer, you can trigger events from your theme or plugin by following this [guide](https://github.com/Pierre-Lannoy/wp-decalog/blob/master/DEVELOPER.md).

### Error code

You can specify a numerical error code with `--code=<code>`. If not specified, the error code will be 0.

### Examples

To trigger a simple notice, type the following command:
```bash
wp log send notice 'All good!'
```

To trigger an error with a 500 error code, type the following command:
```bash
wp log send error 'Something went wrong' --code=500
```

## Managing loggers

With the `wp log logger` command you can perform all available operations on loggers.

### Listing loggers

To obtain a list of set loggers, use `wp log logger list`.

### Starting or pausing loggers

To change the status of a logger, use `wp log logger <start|pause> <uuid>` where `<uuid>` is the identifier of the logger.

### Cleaning or purging loggers

Some loggers allow to be cleaned (deletion of stale records) or purged (deletion of all records). To initiate such an operation on a logger, use `wp log logger <clean|purge> <uuid>` where `<uuid>` is the identifier of the logger.

### Removing a logger

To permanently remove a logger, use `wp log logger remove <uuid>` where `<uuid>` is the identifier of the logger.

### Modifying a logger

To modify a logger, use `wp log logger set <uuid> --settings=<settings>` where `<uuid>` is the identifier of the logger and `<settings>` a json string containing "parameter":value pairs. The available parameters can be browsed with the `wp log type describe` command (see [using logger types](#managing-loggers)).
                                                                                                                                         
`<settings>`  must start with `'{` and end with `}'` (see examples).

> The `wp log logger set` and `wp log logger add` command return the uuid of the corresponding logger. It allows to pipe commands or store the uuid in a variable. To make it more convenient, use `--quiet` (see examples).


### Examples

To list the loggers, type the following command:
```bash
wp log logger list --detail=full
```

To start the logger identified by 'c40c59dc-5e34-44a1-986d-e1ecb520e3ca', type the following command:
```bash
wp log logger start c40c59dc-5e34-44a1-986d-e1ecb520e3ca
```

To purge the logger identified by 'c40c59dc-5e34-44a1-986d-e1ecb520e3ca' without confirmation prompt, type the following command:
```bash
wp log logger purge c40c59dc-5e34-44a1-986d-e1ecb520e3ca --yes
```

To remove the logger identified by 'c40c59dc-5e34-44a1-986d-e1ecb520e3ca' without confirmation prompt, type the following command:
```console
pierre@dev:~$ wp log logger remove c40c59dc-5e34-44a1-986d-e1ecb520e3ca --yes
c40c59dc-5e34-44a1-986d-e1ecb520e3ca
```

To change the settings of the logger identified by 'c40c59dc-5e34-44a1-986d-e1ecb520e3ca', type the following command:
```bash
#!/bin/bash
# Simple line count example, using bash
#
# Bash tutorial: http://linuxconfig.org/Bash_scripting_Tutorial#8-2-read-file-into-bash-array
# My scripting link: http://www.macs.hw.ac.uk/~hwloidl/docs/index.html#scripting
#
# Usage: ./line_count.sh file
# -----------------------------------------------------------------------------

# Link filedescriptor 10 with stdin
exec 10<&0
# stdin replaced with a file supplied as a first argument
exec < $1
# remember the name of the input file
in=$1

# init
file="current_line.txt"
let count=0

# this while loop iterates over all lines of the file
while read LINE
do
    # increase line counter 
    ((count++))
    # write current line to a tmp file with name $file (not needed for counting)
    echo $LINE > $file
    # this checks the return code of echo (not needed for writing; just for demo)
    if [ $? -ne 0 ] 
     then echo "Error in writing to file ${file}; check its permissions!"
    fi
done

echo "Number of lines: $count"
echo "The last line of the file is: `cat ${file}`"

# Note: You can achieve the same by just using the tool wc like this
echo "Expected number of lines: `wc -l $in`"

# restore stdin from filedescriptor 10
# and close filedescriptor 10
exec 0<&10 10<&-
```

## Using logger types

## Managing listeners

## Getting DecaLog status

To get detailed status and operation mode, use the `wp log status` command.

## Managing main settings

To toggle on/off main settings, use `wp log settings <enable|disable> <early-loading|auto-logging|auto-start>`.

If you try to disable a setting, wp-cli will ask you to confirm. To force answer to yes without prompting, just use `--yes`.

### Available settings

- `early-loading`: 
- `auto-logging`:
- `auto-start`:

### Example

To disable early-loading without confirmation prompt, type the following command:
```bash
wp log settings disable early-loading --yes
```